---
title: "S02_data_visualisation"
author: "KM"
date: "2025-08-15"
output: html_document
---



```{r from S01, plus add males that died in fertile vials to prop_fertile_2}
library(tidyverse)
library(readxl)
library(dplyr)

#install.packages("here")

setwd("C:/Users/katem/OneDrive - University of Cambridge/Summer Project 25/TFL_project/data")




raw_data <- read_csv("TFL_raw_data.csv")
head(raw_data)

raw_data <- raw_data %>%
  mutate(prop_survived = survived_recovery / pop_size,
        prop_fertile = fertile / no_crossed_w_LHM)
print(raw_data)

raw_data <- raw_data %>%
  mutate(x = survived_24hr_cross / no_crossed_w_LHM, 
        likely_survived = x * survived_recovery, 
        prop_survived_2 = if_else(survived_24hr_cross == 0 & no_crossed_w_LHM == 0, 
                              0, 
                              likely_survived / pop_size),
        prop_fertile_2 = fertile / (survived_24hr_cross + mdeath_in_fertile_vial))
print(raw_data)

raw_data <- raw_data %>%
  mutate(fertile = if_else(genotype == "tT" & temp_stress == 25, 
                           NA_real_, fertile))

raw_data <- raw_data %>%
  filter(temp_stress !=38)

```



```{r scatter to compare}

raw_data$prop_survived <- round(raw_data$prop_survived, 5)
raw_data$prop_survived_2 <- round(raw_data$prop_survived_2, 5)
raw_data$prop_fertile <- round(raw_data$prop_fertile, 5)
raw_data$prop_fertile_2 <- round(raw_data$prop_fertile_2, 5)

ggplot(raw_data, aes(x = prop_survived, y = prop_survived_2)) +
 geom_point() +
 geom_smooth(method = "lm", se = TRUE)
  


ggplot(raw_data, aes(x = prop_fertile, y = prop_fertile_2)) +
 geom_point() +
 geom_smooth(method = "lm", se = TRUE)




```
the first graph suggests that both survival measures are fairly equivalent, and I think prop_survived is better to use, as it unaffected by the presence of females (24hr survival rate). 
The second graph suggests to me that prop_fertile_2 is a more appropriate measure of fertility, as when accounting for loss of males overnight during the second night, we see that fertility increases significantly, and there are no vials with both overnight deaths and offspring, showing that death, not sterility, are impacting these vials. NOTE: now have vials with overnight deaths and offspring ! both important measures.
So, the two 'prop_fertile' and 'prop_fertile_2' are not interchangeable measures. 

```{r plotting fert against temp, and limiting y axis to a max value of 1 (for proportions)}

library(ggplot2)

ggplot(raw_data, aes( x = temp_stress, y = prop_fertile)) +
 geom_point() +
 geom_smooth(method = "loess", se = FALSE) +
  theme_minimal()
  
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = FALSE) +
  #scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_fertile)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = FALSE) +
  #scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()


ggplot(raw_data, aes(x = temp_stress, y = prop_fertile)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k=5), se = FALSE) +
  scale_y_continuous(limits = c(0,1)) +
  theme_minimal()



             
ggplot(raw_data, aes( x = temp_stress, y = prop_fertile_2)) +
 geom_point() +
 geom_smooth(method = "loess", se = FALSE) + 
  theme_minimal()
          
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = FALSE) +
  #scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = FALSE) +
  #scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()


ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k=5), se = FALSE) +
  scale_y_continuous(limits = c(0,1)) +
  theme_minimal()


library(ggplot2)

library(scales)



```

```{r repeat for survival}

ggplot(raw_data, aes( x = temp_stress, y = prop_survived)) +
 geom_point() +
 geom_smooth(method = "loess", se = FALSE) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k=5), se = FALSE) +
  scale_y_continuous(limits = c(0,1)) +
  theme_minimal()
  

ggplot(raw_data, aes( x = temp_stress, y = prop_survived_2)) +
 geom_point() +
 geom_smooth(method = "loess", se = FALSE) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k=5), se = FALSE) +
  scale_y_continuous(limits = c(0,1)) +
  theme_minimal()

```

```{r look at different lines}


# LOESS
ggplot(raw_data, aes(x = temp_stress, y = prop_survived, colour = genotype)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GLM (binomial)
ggplot(raw_data, aes(x = temp_stress, y = prop_survived, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GLM with cubic polynomial
ggplot(raw_data, aes(x = temp_stress, y = prop_survived, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GAM
ggplot(raw_data, aes(x = temp_stress, y = prop_survived, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k = 5), se = FALSE) +
  scale_y_continuous(limits = c(0,1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

```



```{r} 
# LOESS
ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2, colour = genotype)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GLM (binomial)
ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GLM with cubic polynomial
ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GAM
ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k = 5), se = FALSE) +
  scale_y_continuous(limits = c(0,1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()


```




```{r}
# LOESS
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2, colour = genotype)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GLM (binomial)
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GLM with cubic polynomial
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GAM
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k = 5), se = FALSE) +
  scale_y_continuous(limits = c(0,1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()


```
had a look at flies and can see in some vials, males died during the cross but still had offspring - so must not be ignored (prop_fertile)
```{r}
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile, colour = genotype)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GLM (binomial)
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GLM with cubic polynomial
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()

# GAM
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k = 5), se = FALSE) +
  scale_y_continuous(limits = c(0,1)) +
  scale_color_manual(values = genotype_palette) +
  theme_minimal()
```

orange at 25 degrees seems to be a big outlier - 12/15 was our only fertility measure annoyingly (12 of 15 vials). Have removed this from analysis, above, in first block 




trying facet grid now... 

```{r}
raw_data <- raw_data %>%
  filter(temp_stress !=38)

raw_data$genotype <- factor(
  raw_data$genotype,
  levels = c("mM", "tM", "mT", "tT")
)

ggplot(
  data = raw_data %>% filter(temp_stress > 36), 
  mapping = aes(
    x = genotype,
    y = prop_fertile_2,
    colour = genotype
  )
) +
  geom_point(
    position = position_dodge(0.5),
    size = 3
  ) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = genotype_palette) +
  #geom_errorbar(
  #  aes(ymin = mean_survival - sd_survival, ymax = mean_survival + sd_survival)
  #) +
  labs(
    y = "fertility" 
    ) +
  theme_minimal() +
  facet_grid(~ temp_stress) +
  theme(
    axis.text.x = element_blank(), 
    legend.title = element_text()
    
  )

```

```{r}

  
path_to_results <- here::here("results", "fertility", "R02_fertility_visualisation")






```

```{r}
ggsave(
  filename = here(path_to_results, "F01_fertility_facet.pdf"),
  plot = last_plot(),
  width = 10,
  height = 7 
  
)


1

```




