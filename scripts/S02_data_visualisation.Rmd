---
title: "S02_data_visualisation"
author: "KM"
date: "2025-08-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r from S01}
library(tidyverse)
library(readxl)
library(dplyr)


setwd("C:/Users/katem/OneDrive - University of Cambridge/Summer Project 25/TFL_project/data")

raw_data <- read_csv("TFL_raw_data.csv")
head(raw_data)

raw_data <- raw_data %>%
  mutate(prop_survived = survived_recovery / pop_size,
        prop_fertile = fertile / no_crossed_w_LHM)
print(raw_data)

raw_data <- raw_data %>%
  mutate(x = survived_24hr_cross / no_crossed_w_LHM, 
        likely_survived = x * survived_recovery, 
        prop_survived_2 = if_else(survived_24hr_cross == 0 & no_crossed_w_LHM == 0, 
                              0, 
                              likely_survived / pop_size),
        prop_fertile_2 = fertile / survived_24hr_cross)
print(raw_data)




```



```{r scatter to compare}

raw_data$prop_survived <- round(raw_data$prop_survived, 5)
raw_data$prop_survived_2 <- round(raw_data$prop_survived_2, 5)
raw_data$prop_fertile <- round(raw_data$prop_fertile, 5)
raw_data$prop_fertile_2 <- round(raw_data$prop_fertile_2, 5)

ggplot(raw_data, aes(x = prop_survived, y = prop_survived_2)) +
 geom_point() +
 geom_smooth(method = "lm", se = TRUE)
  


ggplot(raw_data, aes(x = prop_fertile, y = prop_fertile_2)) +
 geom_point() +
 geom_smooth(method = "lm", se = TRUE)




```
the first graph suggests that both survival measures are fairly equivalent, and I think prop_survived is better to use, as it unaffected by the presence of females (24hr survival rate). 
The second graph suggests to me that prop_fertile_2 is a more appropriate measure of fertility, as when accounting for loss of males overnight during the second night, we see that fertility increases significantly, often to 1, and there are no vials with both overnight deaths and offspring, showing that death, not sterility, are impacting these vials. 
So, the two 'prop_fertile' and 'prop_fertile_2' are not interchangeable measures. 

```{r plotting fert against temp, and limiting y axis to a max value of 1 (for proportions)}

library(ggplot2)

ggplot(raw_data, aes( x = temp_stress, y = prop_fertile)) +
 geom_point() +
 geom_smooth(method = "loess", se = TRUE) +
  theme_minimal()
  
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = TRUE) +
  #scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_fertile)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = TRUE) +
  #scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()


ggplot(raw_data, aes(x = temp_stress, y = prop_fertile)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k=5), se = TRUE) +
  scale_y_continuous(limits = c(0,1)) +
  theme_minimal()



             
ggplot(raw_data, aes( x = temp_stress, y = prop_fertile_2)) +
 geom_point() +
 geom_smooth(method = "loess", se = TRUE) + 
  theme_minimal()
          
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = TRUE) +
  #scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = TRUE) +
  #scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()


ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k=5), se = TRUE) +
  scale_y_continuous(limits = c(0,1)) +
  theme_minimal()


library(ggplot2)

library(scales)



```

```{r repeat for survival}

ggplot(raw_data, aes( x = temp_stress, y = prop_survived)) +
 geom_point() +
 geom_smooth(method = "loess", se = TRUE) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k=5), se = TRUE) +
  scale_y_continuous(limits = c(0,1)) +
  theme_minimal()
  



ggplot(raw_data, aes( x = temp_stress, y = prop_survived_2)) +
 geom_point() +
 geom_smooth(method = "loess", se = TRUE) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()

ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k=5), se = TRUE) +
  scale_y_continuous(limits = c(0,1)) +
  theme_minimal()

```

```{r look at different lines}


# LOESS
ggplot(raw_data, aes(x = temp_stress, y = prop_survived, colour = genotype)) +
  geom_point() +
  geom_smooth(method = "loess", se = TRUE) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GLM (binomial)
ggplot(raw_data, aes(x = temp_stress, y = prop_survived, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GLM with cubic polynomial
ggplot(raw_data, aes(x = temp_stress, y = prop_survived, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GAM
ggplot(raw_data, aes(x = temp_stress, y = prop_survived, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k = 5), se = TRUE) +
  scale_y_continuous(limits = c(0,1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

```



```{r} 
# LOESS
ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2, colour = genotype)) +
  geom_point() +
  geom_smooth(method = "loess", se = TRUE) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GLM (binomial)
ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GLM with cubic polynomial
ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GAM
ggplot(raw_data, aes(x = temp_stress, y = prop_survived_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k = 5), se = TRUE) +
  scale_y_continuous(limits = c(0,1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()


```




```{r}
# LOESS
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2, colour = genotype)) +
  geom_point() +
  geom_smooth(method = "loess", se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GLM (binomial)
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GLM with cubic polynomial
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GAM
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile_2, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k = 5), se = TRUE) +
  scale_y_continuous(limits = c(0,1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()


```
had a look at flies and can see in some vials, males died during the cross but still had offspring - so must not be ignored (prop_fertile)
```{r}
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile, colour = genotype)) +
  geom_point() +
  geom_smooth(method = "loess", se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GLM (binomial)
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GLM with cubic polynomial
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "glm",
              formula = y ~ poly(x, 3),
              method.args = list(family = "binomial"),
              se = TRUE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()

# GAM
ggplot(raw_data, aes(x = temp_stress, y = prop_fertile, colour = genotype)) +
  geom_point() +
  stat_smooth(method = "gam", formula = y ~ s(x, k = 5), se = TRUE) +
  scale_y_continuous(limits = c(0,1)) +
  scale_color_manual(values = c("tT" = "orange", 
                                "mT" = "yellow", 
                                "tM" = "green", 
                                "mM" = "blue")) +
  theme_minimal()
```

orange at 25 degrees seems to be a big outlier - 12/15 was our only measure annoyingly (12 of 15 vials)



